# TLS Notes

## WARNING

#### This guide aims to be complete and also serve as a record of creation for the actual certificates and keys that Vaultron uses. Note also that these certificates and keys are for development and experimentation only. DO NOT USE FOR ANY OTHER PURPOSE

This directory contains a set of TLS certificates and keys which were generated by the [Vault PKI Secrets Engine](https://www.vaultproject.io/docs/secrets/pki/index.html). These are the very certificates and keys which are used for end to end mutual TLS as folows:

- Consul server cluster <-> Consul client agents
- Consul client agents <-> Vault servers
- Vault server <-> Vault client

The subdirectories and their contents are organized as follows:

The Terraform templates automatically include TLS configuration for Consul and Vault in all versions from v0.9.0 on.

## Process

The certificates and keys are generated by Vault acting as both Root CA and Intermediate CA per the PKI Secrets Engine documentation.

Vaultron already enables these PKI Secrets Engine configurations:

```
$ vault secrets list | grep pki
vaultron-root-int/             pki          pki_0b742197          Vaultron example PKI secrets engine (for int CA)
vaultron-root-pki/             pki          pki_6e0c68f1          Vaultron example PKI secrets engine (for root CA)
```

So enabling those mounts beforehand is not necessary.

The steps described below are precisely taken to generate the actual certificates and keys in use by Vaultron.

## Tune The Secrets Engine Root CA Mount

Let's make it possible to issue root certificates that can last for at least 2083 days as opposed to Vault's default 30 day TTL.

Tune the Root CA secrets engine mount:

```
$ vault secrets tune \
  -max-lease-ttl=50000h \
  vaultron-root-pki
Success! Tuned the secrets engine at: vaultron-root-pki/
```

## Root CA

The following steps establish a Root CA for Vaultron.

### Root CA Certificate

Generate a CA certificate and key for the Root CA:

```
$ vault write vaultron-root-pki/root/generate/exported \
  common_name=node.arus.consul \
  ttl=50000h \
  organization="Vaultron Lab" \
  country="United States of America" \
  locality="Kittyhawk" \
  province="Outer Banks" \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vaultron-root-ca-cert.pem"} /RSA/ {out="vaultron-root-ca-key.pem"} { print > out }'
```

### Configure URLs

```
$ vault write vaultron-root-pki/config/urls \
  issuing_certificates="http://127.0.0.1:8200/v1/pki/ca" \
  crl_distribution_points="http://127.0.0.1:8200/v1/pki/crl"
Success! Data written to: vaultron-root-pki/config/urls
```

### Configure Role

This Root CA role provides for generating certificates with a **1750 day lifespan**:

```
$ vault write vaultron-root-pki/roles/vaultron-consul-root \
  allow_localhost=true \
  allowed_domains=arus.consul,sura.consul \
  allow_subdomains=true \
  allow_bare_domains=true \
  allow_glob_domains=true \
  allow_ip_sans=true \
  generate_lease=true \
  organization="Vaultron Lab" \
  country="United States of America" \
  locality="Kittyhawk" \
  province="Outer Banks" \
  max_ttl=42000h
Success! Data written to: vaultron-root-pki/roles/vaultron-consul-root
```

### Generate Certificate from Root CA

Normally you'll want to generate certificates from the Intermediate CA and not the Root CA directly, but if you have a specific need, then using the role created above, here is an example certificate generation command:

```
$ vault write vaultron-root-pki/issue/vaultron-consul-root \
    common_name=tacotown.node.arus.consul
```

Since this is just a verification, the output is omitted.

## Intermediate CA

The following steps establish an Intermediate CA for Vaultron.

### Tune The Secrets Engine Intermediate CA Mount

Let's make it possible to issue root certificates that can last for at least **2083 days** as opposed to Vault's default 30 day TTL.

Tune the Intermediate CA secrets engine mount:

```
$ vault secrets tune \
  -max-lease-ttl=50000h \
  vaultron-int-pki
Success! Tuned the secrets engine at: vaultron-int-pki/
```

### Intermediate CA Certificate Signing Request

We generate a certificate signing request with **1750 day TTL**:

```
$ vault write \
  vaultron-int-pki/intermediate/generate/exported \
  common_name=node.arus.consul \
  ttl=42000h \
  -format=json \
  | jq -r '.data.csr + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vaultron-int-csr.pem"} /RSA/ {out="vaultron-int-ca-key.pem"} { print > out }'
```

### Sign Intermediate CA with Root CA

We sign the Intermediate CA specifying a 1750 day TTL. This is the maximum all certificates issued from the Intermediate can have. (4.7 years)

```
$ vault write \
  vaultron-root-pki/root/sign-intermediate \
  csr=@vaultron-int-csr.pem \
  format=pem_bundle \
  ttl=42000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.issuing_ca' \
  | awk '/CERTIFICATE/ {out="vaultron-intermediate-signed.pem"} { print > out }'
```

Now, set the intermediate certificate authority's signing certificate to the root-signed certificate:

```
$ vault write \
  vaultron-int-pki/intermediate/set-signed \
  certificate=@vaultron-intermediate-signed.pem
Success! Data written to: vaultron-int-pki/intermediate/set-signed
```

### Configure URLs

```
$ vault write \
  vaultron-int-pki/config/urls \
  issuing_certificates="http://127.0.0.1:8200/v1/pki_int/ca" \
  crl_distribution_points="http://127.0.0.1:8200/v1/pki_int/crl"
Success! Data written to: vaultron-int-pki/config/urls
```

### Configure a Role

The role has a maximum TTL of 1750 days:

```
$ vault write vaultron-int-pki/roles/vaultron-int \
  allow_subdomains=true \
  allowed_domains=arus.consul,node.arus.consul,node.sura.consul,node.consul,service.consul \
  allow_bare_domains=true \
  allow_glob_domains=true \
  allow_ip_sans=true \
  allow_localhost="true" \
  generate_lease=true \
  organization="Vaultron Lab" \
  country="United States of America" \
  locality="Kittyhawk" \
  province="Outer Banks" \
  max_ttl=42000h \
  ttl=42000h
Success! Data written to: vaultron-int-pki/roles/vaultron-int
```

#### Confirm Role

Ensure the role is correct:

```
$ vault read vaultron-int-pki/roles/vaultron-int
Key                                   Value
---                                   -----
allow_any_name                        false
allow_bare_domains                    true
allow_glob_domains                    true
allow_ip_sans                         true
allow_localhost                       true
allow_subdomains                      true
allow_token_displayname               false
allowed_domains                       [arus.consul node.arus.consul node.sura.consul node.consul service.consul]
allowed_other_sans                    <nil>
allowed_serial_numbers                []
allowed_uri_sans                      []
basic_constraints_valid_for_non_ca    false
client_flag                           true
code_signing_flag                     false
country                               [United States of America]
email_protection_flag                 false
enforce_hostnames                     true
ext_key_usage                         []
ext_key_usage_oids                    []
generate_lease                        true
key_bits                              2048
key_type                              rsa
key_usage                             [DigitalSignature KeyAgreement KeyEncipherment]
locality                              [Kittyhawk]
max_ttl                               42000h
no_store                              false
not_before_duration                   30s
organization                          [Vaultron Lab]
ou                                    []
policy_identifiers                    []
postal_code                           []
province                              [Outer Banks]
require_cn                            true
server_flag                           true
street_address                        []
ttl                                   42000h
use_csr_common_name                   true
use_csr_sans                          true
```

## Issue Certificates

Vaultron uses a private Docker network with predictable address space and we will issue a certificate per container with the loopback IP, static IP as an IP SANs value.

## Vault Servers

Let's make certificates for the Vault servers; we'll use a 19800h/825 day TTL for all of them:

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults0.node.arus.consul \
  alt_names=active.vault.service.consul,standby.vault.service.consul,vault.service.consul,vaults0.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.200" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-0.crt"} /RSA/ {out="vault-server-0.key"} { print > out }'
```

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults1.node.arus.consul \
  alt_names=vaults1.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.201" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-1.crt"} /RSA/ {out="vault-server-1.key"} { print > out }'
```

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults2.node.arus.consul \
  alt_names=vaults2.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.202" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-2.crt"} /RSA/ {out="vault-server-2.key"} { print > out }'
```

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults3.node.arus.consul \
  alt_names=vaults3.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.203" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-3.crt"} /RSA/ {out="vault-server-3.key"} { print > out }'
```

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults4.node.arus.consul \
  alt_names=vaults4.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.204" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-4.crt"} /RSA/ {out="vault-server-4.key"} { print > out }'
```

## Consul Servers

Let's make certificates for the Consul servers; we'll use a 19800h/825 day TTL for all of them:

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consuls0.node.arus.consul \
  alt_names=consul.service.consul,consuls0.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.100" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-server-0.crt"} /RSA/ {out="consul-server-0.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consuls1.node.arus.consul \
  alt_names=consul.service.consul,consuls1.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.101" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-server-1.crt"} /RSA/ {out="consul-server-1.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consuls2.node.arus.consul \
  alt_names=consul.service.consul,consuls2.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.102" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-server-2.crt"} /RSA/ {out="consul-server-2.key"} { print > out }'
```

## Consul Clients

Let's make certificates for the Consul clients; we'll use a 19800h/825 day TTL for all of them:

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consulc0.node.arus.consul \
  alt_names=consul.service.consul,consulc0.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.40" \ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-client-0.crt"} /RSA/ {out="consul-client-0.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consulc1.node.arus.consul \
  alt_names=consul.service.consul,consulc1.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.41" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-client-1.crt"} /RSA/ {out="consul-client-1.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consulc2.node.arus.consul \
  alt_names=consul.service.consul,consulc2.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.42" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-client-2.crt"} /RSA/ {out="consul-client-2.key"} { print > out }'
```

## Create Grafana Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=grafana.node.arus.consul \
  alt_names=grafana.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.220" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="grafana.crt"} /RSA/ {out="grafana.key"} { print > out }'
```

## Create LDAP Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=ldap.node.arus.consul \
  alt_names=ldap.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.221" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="ldap.crt"} /RSA/ {out="ldap.key"} { print > out }'
```

## Create MongoDB Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=mongodb.node.arus.consul \
  alt_names=mongodb.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.222" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="mongodb.crt"} /RSA/ {out="mongodb.key"} { print > out }'
```

## Create MySQL Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=mysql.node.arus.consul \
  alt_names=mysql.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.223" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="mysql.crt"} /RSA/ {out="mysql.key"} { print > out }'
```

## Create PostgreSQL Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=postgresql.node.arus.consul \
  alt_names=postgresql.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.224" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="postgresql.crt"} /RSA/ {out="postgresql.key"} { print > out }'
```

## Create Prometheus Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=prometheus.node.arus.consul \
  alt_names=prometheus.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.225" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="prometheus.crt"} /RSA/ {out="prometheus.key"} { print > out }'
```

## CA Certificate Chain

Take the contents of `vaultron-intermediate-signed.pem` and save as `ca.pem`:

```
-----BEGIN CERTIFICATE-----
MIIEGjCCAwKgAwIBAgIUF1eBP18IQwB5l7UMsw5ezUmliCEwDQYJKoZIhvcNAQEL
BQAwfzEhMB8GA1UEBhMYVW5pdGVkIFN0YXRlcyBvZiBBbWVyaWNhMRQwEgYDVQQI
EwtPdXRlciBCYW5rczESMBAGA1UEBxMJS2l0dHloYXdrMRUwEwYDVQQKEwxWYXVs
dHJvbiBMYWIxGTAXBgNVBAMTEG5vZGUuYXJ1cy5jb25zdWwwHhcNMTkwNzExMTg0
ODEzWhcNMjQwNDI1MTg0ODQzWjAbMRkwFwYDVQQDExBub2RlLmFydXMuY29uc3Vs
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAv9PSC7oYLSha0lfXCIR3
CIBFOMfCGS6B3vG0+GApkoOH/CZPG+YLqWILOb8vp3ghERd4aUY6rLJI0u+WJ1lQ
MHZ4tBcxKy4q2dN1WPfQkmbpwyqtyo80bDiDFMLLqk+Ljvo/XLPtxlqP64WxtIxI
xSvng86vVXPQTR6bE6fYDTZ++sNKCGlU4SQ3XHOrLSmCu8k9kDbaIaztc8cKpuHl
d1jvlOpvI39iOsdYX3Rlg2F9De7lM+32qTnl3/2gPVc20kkkBloZqIVWueP5384i
dqPpKWf4D1rR9rTvFQByWUKeNB14waPVetwuSlVicUqhuneeaGZrwxKRvaMCMoIM
VwIDAQABo4HxMIHuMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0G
A1UdDgQWBBRoV+dMM/N9Bg0RKOW5Q7zKKomIBTAfBgNVHSMEGDAWgBR5mwLrQgA+
Xl7AJcizTmSdaNrbJTA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAKGH2h0dHA6
Ly8xMjcuMC4wLjE6ODIwMC92MS9wa2kvY2EwGwYDVR0RBBQwEoIQbm9kZS5hcnVz
LmNvbnN1bDAxBgNVHR8EKjAoMCagJKAihiBodHRwOi8vMTI3LjAuMC4xOjgyMDAv
djEvcGtpL2NybDANBgkqhkiG9w0BAQsFAAOCAQEA4L3zlRLO5yQXStSrz97zATch
hjXU5wBIpTI5nbFmfcihJvXpL6RUNQnM/6xzvEadVV2M3/j6WokJjY5bj9zErvQ0
ifZdZI3+kLVSukVnztnU/avmm8zMkc0iXiFVfG0DqG4fXyw2UP5dTySdJnqcMZ/2
gD9qPGrTB1CRNWmVp0bxAk8PDE7rv8A8HYCOG94lDc4NEg/31Sl1uzKuCy1k+FsJ
j1i5/fQH+D0o6W89/QyTu5mf8hOWUuQcgRRLdcAtJGYQnqb3VvUzRUCPYqqXZ3kl
29w7Ff0rVjsnipl9EWs+LJL80kzg/mgmbsKf4BLmabFzQZzTVjHvMTKx95iDTg==
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIEDTCCAvWgAwIBAgIUN9mEJ2kIO8i7AjJjP2NjWA3e3TEwDQYJKoZIhvcNAQEL
BQAwfzEhMB8GA1UEBhMYVW5pdGVkIFN0YXRlcyBvZiBBbWVyaWNhMRQwEgYDVQQI
EwtPdXRlciBCYW5rczESMBAGA1UEBxMJS2l0dHloYXdrMRUwEwYDVQQKEwxWYXVs
dHJvbiBMYWIxGTAXBgNVBAMTEG5vZGUuYXJ1cy5jb25zdWwwHhcNMTkwNzExMTg0
NzAxWhcNMjUwMzI1MDI0NzMwWjB/MSEwHwYDVQQGExhVbml0ZWQgU3RhdGVzIG9m
IEFtZXJpY2ExFDASBgNVBAgTC091dGVyIEJhbmtzMRIwEAYDVQQHEwlLaXR0eWhh
d2sxFTATBgNVBAoTDFZhdWx0cm9uIExhYjEZMBcGA1UEAxMQbm9kZS5hcnVzLmNv
bnN1bDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAOf37uQPWhir4pg2
xUSXV6gTutvJZI9TM5NK7BrFaUexdInpUl0CMGYDJJYKJ2gpiSjqOaU+Iya9YC2w
+Wz88tI1p1FfT4nrUKzQCDqcqAgm3lFChgFqkALhWlWuXwaRUh2xIehV4KGVdkWG
ZwH2kl/uE8fkgmfV5mOJvyfvz1z2ngVoKmODBfvN722AnQL9IGp9JA0IYji013Qv
hElysRkosCMfVIwefiBGNpoV5HN7tdBhAl9bWbzBjmJ1bGwAmQGXEKhACaNJafBJ
JCfrfaHfuWMJDMURkz5Blxu+wG7CWjaeuXPddW/Vd7iPomfh4CU+Qrlb8bQ9y/hh
CWgC5I0CAwEAAaOBgDB+MA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/
MB0GA1UdDgQWBBR5mwLrQgA+Xl7AJcizTmSdaNrbJTAfBgNVHSMEGDAWgBR5mwLr
QgA+Xl7AJcizTmSdaNrbJTAbBgNVHREEFDASghBub2RlLmFydXMuY29uc3VsMA0G
CSqGSIb3DQEBCwUAA4IBAQCbxtx8w0xHZR7cEpz1LDgP2wegqeQehzyDITEiqsOc
lNuCfPTh4mDHHn2rr+czuLPpdJd/xcxqxf8PlTD3kHI+QstT4N9fWiMi3kWK5F7j
HYDqenUoLixHQqGLAFqUP8IuqfjudQhmdCFYIkcmv1Y0f/yn7shbQy929G3HRVBT
YykNjTBzixgKsbiGC+BwIpZInMoJUB4L/ujBKdPghN8tCTjS62+UH5U8Mt6hb/Mh
+hhd1uRqQdoCNJU2whZ5gyeNXe7W/hUhN1bgC7puKHP0bSGowbr28KPUJkxKs5DB
iiW+ZS/YMoshe8270u8uwe0WQ7TF1oCxcl5OLrhMexA8
-----END CERTIFICATE-----
```

Use this as the value for `-ca-cert=` or `VAULT_CACERT` or import it into your OS trust store to have all of Vaultron's certificates trusted by default.

## Import into New Vault

### Root CA

Use a PEM bundle containing the certificates and key:

